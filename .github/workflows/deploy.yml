name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Install CLI tools
        run: npm install -g vercel neonctl


      - name: Provision postgres
        run: chmod +x scripts/provision-postgres.sh && scripts/provision-postgres.sh
        env:
          NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
          NEON_ORG_ID: ${{ secrets.NEON_ORG_ID }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}

      - name: Provision frontend
        run: chmod +x scripts/provision-frontend.sh && scripts/provision-frontend.sh
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          ROUTE53_HOSTED_ZONE_ID: ${{ secrets.ROUTE53_HOSTED_ZONE_ID }}

      - name: Provision auth
        run: chmod +x scripts/provision-auth.sh && scripts/provision-auth.sh
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
          ALLOWED_EMAILS: ${{ secrets.ALLOWED_EMAILS }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}



      - name: Deploy postgres - npx drizzle-kit push
        run: npx drizzle-kit push
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Deploy frontend - vercel --prod --yes --token $VERCEL_TOKE
        run: vercel --prod --yes --token $VERCEL_TOKEN
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

